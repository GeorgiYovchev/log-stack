---
- name: Deploy Log Stack Configuration (Smart Restart)
  hosts: log_stack
  become: true
  vars:
    log_stack_path: /opt/log-stack
    
  tasks:
    - name: Create log-stack directory
      file:
        path: "{{ log_stack_path }}"
        state: directory
        mode: '0755'

    - name: Backup current docker-compose.yml
      copy:
        src: "{{ log_stack_path }}/docker-compose.yml"
        dest: "{{ log_stack_path }}/docker-compose.yml.backup"
        remote_src: yes
      ignore_errors: true

    - name: Copy new docker-compose.yml
      copy:
        src: docker-compose.yml
        dest: "{{ log_stack_path }}/docker-compose.yml.new"
        mode: '0644'

    - name: Check if Kafka config changed in docker-compose
      shell: |
        if [ ! -f {{ log_stack_path }}/docker-compose.yml.backup ]; then
          echo "true"
        else
          diff <(grep -A 30 "kafka:" {{ log_stack_path }}/docker-compose.yml.backup | head -35) \
               <(grep -A 30 "kafka:" {{ log_stack_path }}/docker-compose.yml.new | head -35) > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "true"
          else
            echo "false"
          fi
        fi
      args:
        executable: /bin/bash
      register: kafka_config_changed
      changed_when: false

    - name: Check if Loki config changed in docker-compose
      shell: |
        if [ ! -f {{ log_stack_path }}/docker-compose.yml.backup ]; then
          echo "true"
        else
          # Extract only the loki service block (stop at next service or networks)
          diff <(sed -n '/^  loki:/,/^  [a-z]/p' {{ log_stack_path }}/docker-compose.yml.backup | head -n -1) \
               <(sed -n '/^  loki:/,/^  [a-z]/p' {{ log_stack_path }}/docker-compose.yml.new | head -n -1) > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "true"
          else
            echo "false"
          fi
        fi
      args:
        executable: /bin/bash
      register: loki_compose_changed
      changed_when: false

    - name: Check if Grafana config changed in docker-compose
      shell: |
        if [ ! -f {{ log_stack_path }}/docker-compose.yml.backup ]; then
          echo "true"
        else
          # Extract only the grafana service block
          diff <(sed -n '/^  grafana:/,/^  [a-z]/p' {{ log_stack_path }}/docker-compose.yml.backup | head -n -1) \
               <(sed -n '/^  grafana:/,/^  [a-z]/p' {{ log_stack_path }}/docker-compose.yml.new | head -n -1) > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "true"
          else
            echo "false"
          fi
        fi
      args:
        executable: /bin/bash
      register: grafana_compose_changed
      changed_when: false

    - name: Check if Fluent Bit config changed in docker-compose
      shell: |
        if [ ! -f {{ log_stack_path }}/docker-compose.yml.backup ]; then
          echo "true"
        else
          diff <(grep -A 10 "fluent-bit:" {{ log_stack_path }}/docker-compose.yml.backup | head -15) \
               <(grep -A 10 "fluent-bit:" {{ log_stack_path }}/docker-compose.yml.new | head -15) > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "true"
          else
            echo "false"
          fi
        fi
      args:
        executable: /bin/bash
      register: fluentbit_compose_changed
      changed_when: false

    - name: Move new docker-compose.yml to final location
      command: mv {{ log_stack_path }}/docker-compose.yml.new {{ log_stack_path }}/docker-compose.yml
      when: kafka_config_changed.stdout == "true" or 
            loki_compose_changed.stdout == "true" or 
            grafana_compose_changed.stdout == "true" or
            fluentbit_compose_changed.stdout == "true"

    - name: Copy fluent-bit.conf
      copy:
        src: fluent-bit.conf
        dest: "{{ log_stack_path }}/fluent-bit.conf"
        mode: '0644'
      register: fluent_bit_result

    - name: Copy loki-config.yml
      copy:
        src: loki-config.yml
        dest: "{{ log_stack_path }}/loki-config.yml"
        mode: '0644'
      register: loki_config_result

    - name: Copy Lua Script for Fluent Bit
      copy: 
        src: set_level.lua
        dest: "{{ log_stack_path }}/lua/set_level.lua"
        mode: '0644'
      register: lua_script_result

    - name: Show what will be restarted
      debug:
        msg:
          - "Kafka restart: {{ 'YES' if kafka_config_changed.stdout == 'true' else 'NO' }}"
          - "Loki restart: {{ 'YES' if (loki_compose_changed.stdout == 'true' or loki_config_result.changed) else 'NO' }}"
          - "Grafana restart: {{ 'YES' if grafana_compose_changed.stdout == 'true' else 'NO' }}"
          - "Fluent Bit restart: {{ 'YES' if (fluentbit_compose_changed.stdout == 'true' or fluent_bit_result.changed or lua_script_result.changed) else 'NO' }}"

    - name: Restart Kafka (only if Kafka config changed)
      block:
        - name: Stop Kafka
          community.docker.docker_compose_v2:
            project_src: "{{ log_stack_path }}"
            services:
              - kafka
            state: stopped
        
        - name: Start Kafka
          community.docker.docker_compose_v2:
            project_src: "{{ log_stack_path }}"
            services:
              - kafka
            state: started
      when: kafka_config_changed.stdout == "true"

    - name: Restart Loki (if Loki docker-compose or loki-config.yml changed)
      block:
        - name: Stop Loki
          community.docker.docker_compose_v2:
            project_src: "{{ log_stack_path }}"
            services:
              - loki
            state: stopped
        
        - name: Start Loki
          community.docker.docker_compose_v2:
            project_src: "{{ log_stack_path }}"
            services:
              - loki
            state: started
      when: loki_compose_changed.stdout == "true" or loki_config_result.changed

    - name: Restart Grafana (only if Grafana config changed)
      block:
        - name: Stop Grafana
          community.docker.docker_compose_v2:
            project_src: "{{ log_stack_path }}"
            services:
              - grafana
            state: stopped
        
        - name: Start Grafana
          community.docker.docker_compose_v2:
            project_src: "{{ log_stack_path }}"
            services:
              - grafana
            state: started
      when: grafana_compose_changed.stdout == "true"

    - name: Restart Fluent Bit (if Fluent Bit docker-compose or fluent-bit.conf or lua changed)
      block:
        - name: Stop Fluent Bit
          community.docker.docker_compose_v2:
            project_src: "{{ log_stack_path }}"
            services:
              - fluent-bit
            state: stopped
        
        - name: Start Fluent Bit
          community.docker.docker_compose_v2:
            project_src: "{{ log_stack_path }}"
            services:
              - fluent-bit
            state: started
      when: fluentbit_compose_changed.stdout == "true" or fluent_bit_result.changed or lua_script_result.changed

    - name: Verify all services are running
      command: docker compose -f {{ log_stack_path }}/docker-compose.yml ps
      register: compose_ps
      
    - name: Show running services
      debug:
        var: compose_ps.stdout_lines

    - name: Cleanup backup
      file:
        path: "{{ log_stack_path }}/docker-compose.yml.backup"
        state: absent